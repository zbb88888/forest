# 玩家系统

## 系统概述
玩家系统管理玩家实体、背包、装备栏等核心玩家数据，是游戏交互的中心。

---

## 1. 玩家组件

### 1.1 实现文件
- **组件**：`src/components/player.rs` (Player, PlayerBundle)
- **系统**：`src/systems/player.rs` (spawn_player, move_player_randomly)

### 1.2 玩家属性

```rust
pub struct Player {
    pub id: u64,
    pub name: String,
}
```

### 1.3 玩家背包

```rust
pub struct Inventory {
    pub metal: u32,
    pub soil: u32,
    pub energy: u32,
}
```

### 1.4 玩家装备栏

```rust
pub struct EquipmentBar {
    pub weapon: Option<Entity>,
    pub armor: Option<Entity>,
    pub accessory: Option<Entity>,
}
```

---

## 2. 生成系统

### 2.1 生成位置
- **位置**：地图中心
- **坐标计算**：
  ```rust
  let center_x = world_map.width / 2;
  let center_y = world_map.height / 2;
  let pos_x = offset_x + center_x as f32 * tile_size;
  let pos_y = offset_y + center_y as f32 * tile_size;
  ```

### 2.2 初始状态
- **ID**：0
- **名称**："Administrator"
- **能源**：100
- **金属**：0
- **土壤**：0
- **装备**：无

### 2.3 视觉参数
- **颜色**：红色
- **大小**：32×32像素（瓦片的80%）
- **层级**：Z=1

---

## 3. 移动系统

### 3.1 当前实现
- **移动方式**：随机移动
- **移动频率**：每1秒一次
- **移动距离**：1个瓦片

### 3.2 移动逻辑
```rust
// 随机方向：0=Up, 1=Down, 2=Left, 3=Right
let direction = random(0..4);

match direction {
    0 => new_y += 1.0,    // Up
    1 => new_y -= 1.0,    // Down
    2 => new_x -= 1.0,    // Left
    3 => new_x += 1.0,    // Right
}
```

### 3.3 边界检查
```rust
if new_x >= 0.0 && new_x < world_map.width as f32 &&
   new_y >= 0.0 && new_y < world_map.height as f32 {
    // 允许移动
} else {
    // 撞墙
}
```

### 3.4 待实现功能
- [ ] WASD控制
- [ ] 鼠标移动
- [ ] 碰撞检测
- [ ] 地形阻挡

---

## 4. 资源管理

### 4.1 资源类型

| 资源 | 初始值 | 主要来源 | 主要用途 |
|------|--------|----------|----------|
| Energy | 100 | 植物收获、机器人采集 | 种植、升级、充能 |
| Metal | 0 | 待实现 | 待实现 |
| Soil | 0 | 待实现 | 待实现 |

### 4.2 资源获取
- **植物收获**：直接获得能源
- **机器人采集**：机器人返回时加入背包
- **其他来源**：待实现

### 4.3 资源消耗
- **种植植物**：待实现消耗
- **升级装备**：50能源/次
- **机器人充能**：自动充能（无消耗）
- **其他用途**：待实现

---

## 5. 装备管理

### 5.1 装备栏
- **武器槽**：装备武器
- **护甲槽**：装备护甲
- **饰品槽**：装备饰品

### 5.2 装备操作
- **生成装备**：键盘 E
- **拾取装备**：键盘 F
- **升级装备**：键盘 U

### 5.3 属性计算
- 总属性 = 所有装备属性之和
- 暴击倍率取最大值
- 实时更新

---

## 6. 交互系统

### 6.1 当前交互
- **右键**：种植植物
- **左键**：收获植物/拾取装备
- **键盘 1-4**：生成机器人
- **键盘 E**：生成装备
- **键盘 F**：拾取装备
- **键盘 U**：升级装备

### 6.2 待实现交互
- [ ] WASD移动
- [ ] 打开背包
- [ ] 打开装备栏
- [ ] 使用技能
- [ ] 与NPC对话

---

## 7. 系统集成

### 7.1 初始化顺序
```rust
.add_systems(OnEnter(GameState::InGame), (
    systems::map::setup_map,
    systems::player::spawn_player
).chain())
```

### 7.2 更新顺序
```rust
.add_systems(Update, (
    systems::player::move_player_randomly,
).run_if(in_state(GameState::InGame)))
```

### 7.3 依赖关系
- 依赖地图系统（获取地图尺寸）
- 依赖资源系统（管理背包）
- 依赖装备系统（管理装备栏）
- 被多个系统依赖（位置、背包、装备）

---

## 8. 性能优化

### 8.1 移动优化
- 使用平滑移动
- 避免频繁更新
- 缓存位置计算

### 8.2 资源优化
- 批量更新资源
- 避免频繁查询
- 使用事件系统

### 8.3 装备优化
- 缓存属性计算
- 延迟更新UI
- 批量操作

---

## 9. 待实现功能

### 9.1 移动增强
- [ ] WASD控制
- [ ] 鼠标跟随
- [ ] 路径规划
- [ ] 移动动画

### 9.2 交互增强
- [ ] 背包界面
- [ ] 装备栏界面
- [ ] 技能栏
- [ ] 快捷键系统

### 9.3 角色系统
- [ ] 角色升级
- [ ] 技能树
- [ ] 属性点
- [ ] 成就系统

---

## 10. 已知问题

### 10.1 移动问题
- 只能随机移动
- 无法控制方向
- 缺少碰撞检测

### 10.2 资源问题
- 金属和土壤未实现获取
- 资源显示简陋
- 缺少背包界面

### 10.3 装备问题
- 装备栏不可见
- 无法查看装备详情
- 无法卸下装备

---

## 11. 更新日志

### v0.1.0 (当前版本)
- ✅ 实现玩家生成
- ✅ 实现随机移动
- ✅ 实现背包系统
- ✅ 实现装备栏
- ✅ 实现基础交互
