# Dark Forest 系统依赖关系图

## 文档说明
本文档定义了游戏各系统之间的单向依赖关系，是后续开发优先级判断的第一参考。

**依赖原则**：
1. 依赖关系必须是单向的（避免循环依赖）
2. 基础系统优先实现
3. 高层系统依赖低层系统
4. 同层系统之间尽量减少依赖

---

## 系统分层

### 第0层：核心基础层
最基础的系统，不依赖任何其他系统。

- **游戏状态系统** (`src/states/mod.rs`)
  - 管理游戏状态（MainMenu, InGame, Paused, GameOver）
  - 不依赖任何系统

### 第1层：环境基础层
提供游戏世界的基础框架。

- **地图系统** (`src/systems/map.rs`)
  - 依赖：游戏状态系统
  - 提供地形、瓦片数据

- **时间系统** (`src/systems/time.rs`)
  - 依赖：游戏状态系统
  - 提供昼夜、月相数据

### 第2层：环境增强层
基于环境基础层，提供更丰富的环境特性。

- **光照系统** (`src/systems/lighting.rs`)
  - 依赖：时间系统
  - 提供动态光照效果

### 第3层：实体基础层
游戏中的基础实体系统。

- **玩家系统** (`src/systems/player.rs`)
  - 依赖：地图系统（位置）
  - 提供玩家实体、背包、装备栏

### 第4层：资源系统层
管理游戏中的资源。

- **资源组件系统** (`src/components/resource.rs`)
  - 依赖：玩家系统
  - 提供资源类型、背包管理

### 第5层：内容系统层
游戏的核心玩法内容。

- **植物系统** (`src/systems/plant.rs`)
  - 依赖：地图系统（地形、位置）
  - 依赖：时间系统（昼夜影响生长）
  - 依赖：玩家系统（种植、收获）
  - 依赖：资源系统（能源产出）

- **机器人系统** (`src/systems/robot.rs`)
  - 依赖：地图系统（移动）
  - 依赖：时间系统（夜晚影响）
  - 依赖：玩家系统（返回基地）
  - 依赖：植物系统（采集目标）
  - 依赖：资源系统（资源携带）

### 第6层：增强系统层
增强游戏玩法的系统。

- **装备系统** (`src/systems/equipment.rs`)
  - 依赖：玩家系统（装备栏）
  - 依赖：资源系统（消耗能源升级）

### 第7层：界面系统层
用户界面系统。

- **UI系统** (`src/ui/menu.rs`, `src/ui/hud.rs`)
  - 依赖：游戏状态系统
  - 依赖：玩家系统（显示背包）
  - 依赖：时间系统（显示时间）
  - 依赖：资源系统（显示资源）

---

## 依赖关系图

```
第0层：核心基础层
└── 游戏状态系统

第1层：环境基础层
├── 地图系统 ──────┐
└── 时间系统 ──────┤
                   │
第2层：环境增强层     │
└── 光照系统 ◄─────┘

第3层：实体基础层
└── 玩家系统 ◄─────┐
                   │
第4层：资源系统层     │
└── 资源系统 ◄─────┘
                   │
第5层：内容系统层     │
├── 植物系统 ◄─────┼───┐
│                   │   │
└── 机器人系统 ◄─────┘   │
                           │
第6层：增强系统层         │
└── 装备系统 ◄─────────┘
                   │
第7层：界面系统层
└── UI系统 ◄───────────┘
```

---

## 详细依赖关系

### 1. 游戏状态系统
**依赖**：无

**被依赖**：
- 地图系统
- 时间系统
- UI系统

**实现优先级**：0（最高）

---

### 2. 地图系统
**依赖**：
- 游戏状态系统（仅在InGame状态运行）

**被依赖**：
- 玩家系统（获取地图尺寸、位置）
- 植物系统（获取地形、种植位置）
- 机器人系统（移动、地形检测）

**实现优先级**：1

---

### 3. 时间系统
**依赖**：
- 游戏状态系统（仅在InGame状态运行）

**被依赖**：
- 光照系统（获取昼夜阶段）
- 植物系统（获取昼夜影响）
- 机器人系统（获取夜晚影响）
- UI系统（显示时间）

**实现优先级**：1

---

### 4. 光照系统
**依赖**：
- 时间系统（获取昼夜阶段计算光照）

**被依赖**：无

**实现优先级**：2

---

### 5. 玩家系统
**依赖**：
- 地图系统（获取地图尺寸、计算位置）

**被依赖**：
- 资源系统（管理玩家背包）
- 植物系统（种植、收获交互）
- 机器人系统（返回基地）
- 装备系统（装备栏管理）
- UI系统（显示玩家信息）

**实现优先级**：3

---

### 6. 资源系统
**依赖**：
- 玩家系统（管理玩家背包）

**被依赖**：
- 植物系统（能源产出）
- 机器人系统（资源携带）
- 装备系统（消耗能源）
- UI系统（显示资源）

**实现优先级**：4

---

### 7. 植物系统
**依赖**：
- 地图系统（获取地形、种植位置）
- 时间系统（获取昼夜影响生长）
- 玩家系统（种植、收获交互）
- 资源系统（能源产出）

**被依赖**：
- 机器人系统（采集目标）

**实现优先级**：5

---

### 8. 机器人系统
**依赖**：
- 地图系统（移动、地形检测）
- 时间系统（获取夜晚影响）
- 玩家系统（返回基地）
- 植物系统（采集目标）
- 资源系统（资源携带）

**被依赖**：无

**实现优先级**：5

---

### 9. 装备系统
**依赖**：
- 玩家系统（装备栏管理）
- 资源系统（消耗能源升级）

**被依赖**：无

**实现优先级**：6

---

### 10. UI系统
**依赖**：
- 游戏状态系统（根据状态显示不同UI）
- 玩家系统（显示玩家信息）
- 时间系统（显示时间）
- 资源系统（显示资源）

**被依赖**：无

**实现优先级**：7

---

## 依赖规则

### 基础规则
1. **单向依赖**：系统A依赖系统B，则B不能依赖A
2. **分层原则**：高层系统只能依赖低层系统
3. **最小依赖**：系统应尽量减少依赖
4. **接口清晰**：依赖通过明确的接口进行

### 开发规则
1. **自底向上**：从低层系统开始实现
2. **依赖优先**：实现系统前确保其依赖已实现
3. **接口先行**：先定义接口，再实现功能
4. **逐步集成**：每完成一层，进行集成测试

### 维护规则
1. **依赖更新**：修改系统时更新依赖关系
2. **循环检测**：新增依赖时检查是否产生循环
3. **文档同步**：依赖变化时同步更新本文档
4. **版本记录**：记录依赖关系的版本历史

---

## 待实现系统依赖

### 战斗系统（待实现）
**计划依赖**：
- 玩家系统
- 装备系统（武器属性）
- 时间系统（昼夜影响战斗）
- 地图系统（战斗位置）

**被依赖**：
- 敌人系统
- 防御系统

**计划优先级**：8

---

### 建造系统（待实现）
**计划依赖**：
- 玩家系统（建造指令）
- 地图系统（建造位置）
- 资源系统（消耗资源）
- 机器人系统（建造机器人）

**被依赖**：
- 防御系统

**计划优先级**：8

---

### 敌人系统（待实现）
**计划依赖**：
- 地图系统（移动）
- 时间系统（昼夜影响）
- 战斗系统（战斗逻辑）

**被依赖**：无

**计划优先级**：9

---

### 防御系统（待实现）
**计划依赖**：
- 地图系统（防御塔位置）
- 战斗系统（攻击逻辑）
- 建造系统（建造防御塔）
- 机器人系统（防御机器人）

**被依赖**：无

**计划优先级**：10

---

## 依赖关系矩阵

| 系统 | 游戏状态 | 地图 | 时间 | 光照 | 玩家 | 资源 | 植物 | 机器人 | 装备 | UI |
|------|---------|------|------|------|------|------|------|--------|------|-----|
| 游戏状态 | - | - | - | - | - | - | - | - | - | - |
| 地图 | ✓ | - | - | - | - | - | - | - | - | - |
| 时间 | ✓ | - | - | - | - | - | - | - | - | - |
| 光照 | - | - | ✓ | - | - | - | - | - | - | - |
| 玩家 | - | ✓ | - | - | - | - | - | - | - | - |
| 资源 | - | - | - | - | ✓ | - | - | - | - | - |
| 植物 | - | ✓ | ✓ | - | ✓ | ✓ | - | - | - | - |
| 机器人 | - | ✓ | ✓ | - | ✓ | ✓ | ✓ | - | - | - |
| 装备 | - | - | - | - | ✓ | ✓ | - | - | - | - |
| UI | ✓ | - | - | - | ✓ | ✓ | - | - | - | ✓ |

**说明**：✓ 表示依赖（行依赖列）

---

## 开发优先级总结

### 第一阶段（已完成）
1. 游戏状态系统
2. 地图系统
3. 时间系统
4. 光照系统
5. 玩家系统
6. 资源系统
7. 植物系统
8. 机器人系统
9. 装备系统
10. UI系统

### 第二阶段（待实现）
11. 战斗系统
12. 建造系统
13. 敌人系统
14. 防御系统

### 第三阶段（待规划）
15. 任务系统
16. 成就系统
17. 存档系统
18. 多人联机系统（不考虑）

---

## 版本历史

### v1.0.0 (当前版本)
- 建立完整的系统依赖关系图
- 定义7层系统架构
- 完成10个基础系统的依赖关系
- 规划4个待实现系统的依赖关系

---

## 维护说明

### 更新流程
1. 新增系统时：
   - 确定系统所在层级
   - 列出所有依赖
   - 检查是否产生循环
   - 更新依赖关系图
   - 更新依赖关系矩阵

2. 修改系统时：
   - 检查依赖关系是否变化
   - 如有变化，更新本文档
   - 通知相关系统维护者

3. 删除系统时：
   - 更新被依赖系统
   - 从依赖关系图中移除
   - 更新依赖关系矩阵

### 注意事项
- 保持依赖关系的单向性
- 避免跨层依赖
- 最小化依赖数量
- 定期审查依赖关系合理性
