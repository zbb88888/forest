# 环境系统

## 系统概述
环境系统包括地图系统、时间系统和光照系统，为游戏提供基础的世界框架和动态环境变化。

---

## 1. 地图系统

### 1.1 实现文件
- **组件**：`src/components/resource.rs` (TileType, MapTile, WorldMap)
- **系统**：`src/systems/map.rs` (setup_map)

### 1.2 地形类型

| 类型 | 颜色 | 可通行 | 能源产出 | 分布 |
|------|------|--------|----------|------|
| Grass | 绿色 | 是 | 1.0x | 50% |
| Forest | 深绿色 | 是 | 1.5x | 25% |
| Mountain | 灰色 | 否 | 0.5x | 7% |
| Water | 蓝色 | 否 | 0.8x | 5% |
| Desert | 沙黄色 | 是 | 0.7x | 10% |
| DarkForest | 深暗绿色 | 是 | 2.0x | 3% |

### 1.3 地图瓦片属性

```rust
pub struct MapTile {
    pub tile_type: TileType,
    pub x: u32,
    pub y: u32,
    pub explored: bool,      // 是否已探索
    pub visible: bool,        // 是否当前可见
}
```

### 1.4 地图参数
- **尺寸**：20x20 瓦片
- **瓦片大小**：32x32 像素
- **战争迷雾**：启用
- **地图种子**：随机生成

### 1.5 功能接口
- `get_tile(x, y)` - 获取指定位置瓦片
- `get_tile_mut(x, y)` - 获取可变瓦片引用
- `explore_area(center_x, center_y, radius)` - 探索指定区域

### 1.6 地形影响
- **可通行性**：山脉和水域不可通行
- **能源产出**：不同地形有不同的能源产出倍率
- **植物种植**：只能在草地、森林、黑暗森林种植
- **自动选择**：根据地形自动选择植物类型
  - 草地 → 草
  - 森林 → 灌木
  - 黑暗森林 → 能源花

---

## 2. 时间系统

### 2.1 实现文件
- **组件**：`src/systems/time.rs` (GameTime, DayPhase, MoonPhase)
- **系统**：`src/systems/time.rs` (update_time, init_game_time)

### 2.2 昼夜阶段

| 阶段 | 时间 | 光照 | 植物生长 |
|------|------|------|----------|
| Dawn | 5-7点 | 0.0→1.0 | 正常 |
| Day | 7-18点 | 1.0 | 1.5x |
| Dusk | 18-20点 | 1.0→0.0 | 正常 |
| Night | 20-5点 | 0.2 | 0.5x |

### 2.3 月相系统（15日周期）

| 月相 | 日期 | 资源产出 | AI扫描强度 | 特殊效果 |
|------|------|----------|------------|----------|
| NewMoon | 第1日 | 2.0x | 0.1 | - |
| WaxingCrescent | 第2-3日 | 1.8x | 0.2 | - |
| FirstQuarter | 第4日 | 1.6x | 0.3 | - |
| WaxingGibbous | 第5-7日 | 1.4x | 0.4 | - |
| FullMoon | 第8日 | 2.0x | 0.0 | 平安夜（AI过热停机） |
| WaningGibbous | 第9-11日 | 1.2x | 0.5 | - |
| LastQuarter | 第12日 | 1.0x | 0.6 | - |
| WaningCrescent | 第13-14日 | 0.8x | 0.7 | - |
| DarkMoon | 第15日 | 0.5x | 0.5 | 终极挑战 |

### 2.4 时间参数
- **一天长度**：60秒（可配置）
- **时间更新**：基于实际时间增量
- **小时计算**：(实际秒数 / 一天长度) × 24小时

### 2.5 时间影响
- **植物生长**：白天1.5x，夜晚0.5x
- **机器人效率**：夜晚降至50%
- **资源产出**：受月相影响
- **AI活跃度**：受月相扫描强度影响

---

## 3. 光照系统

### 3.1 实现文件
- **组件**：`src/systems/lighting.rs` (EnvironmentLighting)
- **系统**：`src/systems/lighting.rs` (update_lighting, init_lighting)

### 3.2 光照颜色

| 昼夜阶段 | 颜色 | RGB值 |
|----------|------|-------|
| Dawn | 暖黄色 | (1.0, 0.9, 0.7) |
| Day | 白色 | (1.0, 1.0, 1.0) |
| Dusk | 橙红色 | (1.0, 0.6, 0.4) |
| Night | 蓝紫色 | (0.3, 0.3, 0.5) |

### 3.3 光照强度
- **黎明**：0.0 → 1.0（线性渐变）
- **白天**：1.0（最大）
- **黄昏**：1.0 → 0.0（线性渐变）
- **夜晚**：0.2（保留基础亮度）

### 3.4 光照计算
```rust
pub fn light_intensity(&self, hour: f32) -> f32 {
    match self {
        DayPhase::Dawn => (hour - 5.0) / 2.0,
        DayPhase::Day => 1.0,
        DayPhase::Dusk => 1.0 - (hour - 18.0) / 2.0,
        DayPhase::Night => 0.2,
    }
}
```

---

## 4. 系统集成

### 4.1 初始化顺序
1. `setup` - 基础设置
2. `init_game_time` - 初始化时间系统
3. `init_lighting` - 初始化光照系统
4. `setup_map` - 生成地图（进入游戏时）

### 4.2 更新顺序
```rust
.add_systems(Update, (
    systems::time::update_time,
    systems::lighting::update_lighting,
).run_if(in_state(GameState::InGame)))
```

### 4.3 依赖关系
- 光照系统依赖时间系统（获取当前昼夜阶段）
- 时间系统独立运行
- 地图系统独立运行

---

## 5. 性能优化

### 5.1 地图优化
- 使用二维数组存储瓦片
- 预计算地图偏移
- 避免频繁的内存分配

### 5.2 时间优化
- 使用增量时间更新
- 避免每帧重复计算
- 缓存光照强度

### 5.3 光照优化
- 仅在昼夜阶段变化时更新
- 使用插值平滑过渡
- 批量更新相同类型的瓦片

---

## 6. 待实现功能

### 6.1 地图系统
- [ ] 动态地形变化
- [ ] 地图编辑器
- [ ] 多层地图支持
- [ ] 地图保存/加载

### 6.2 时间系统
- [ ] 时间加速/减速
- [ ] 时间倒流机制
- [ ] 特殊时间事件
- [ ] 时间可视化效果

### 6.3 光照系统
- [ ] 实时阴影
- [ ] 光源系统
- [ ] 环境光遮蔽
- [ ] 光照材质

---

## 7. 已知问题

### 7.1 地图系统
- 地图尺寸固定为20x20
- 地形分布完全随机
- 缺少地形过渡效果

### 7.2 时间系统
- 昼夜切换不够平滑
- 缺少时间可视化UI
- 月相效果不明显

### 7.3 光照系统
- 光照变化仅影响颜色
- 缺少实时阴影
- 光照范围有限

---

## 8. 更新日志

### v0.1.0 (当前版本)
- ✅ 实现6种地形类型
- ✅ 实现昼夜循环
- ✅ 实现15日月相系统
- ✅ 实现动态光照
- ✅ 实现战争迷雾
- ✅ 实现地图探索机制
